# Genealogy Import Tracking

**Purpose:** Track discovered entities during the import pipeline to ensure systematic coverage.

---

## Workflow Overview

1. **Start with a person or group** - Use `/import-person` or `/import-group` command
2. **Review output** - Copy generated SQL to your import file
3. **Track discovered entities** - Add new persons/groups to tracking files
4. **Repeat** - Process next entity from backlog

---

## Tracking Files

Maintain two tracking files in `docs/genealogy/import-backlog/`:

### `persons-backlog.md` - Persons to Import

```markdown
# Persons Import Backlog

## Status Legend
- `pending` - Not yet processed
- `in_progress` - Currently researching
- `done` - SQL generated, added to import set
- `skipped` - Decided not to import (document reason)

## Backlog

| Apelido | Apelido Context | Full Name | Title | Discovered From | Status | Notes |
|---------|-----------------|-----------|-------|-----------------|--------|-------|
| João Grande | | João Oliveira dos Santos | mestre | GCAP import | pending | |
| Moraes | | Pedro Moraes Trindade | mestre | GCAP import | pending | |
| Pastinha | | Vicente Ferreira Pastinha | mestre | João Grande import | done | Historical figure |
| Mestre Cobra | Salvador (Senzala) | | mestre | | pending | Needs context - multiple Cobras exist |
| Mestre Cobra | São Paulo (ABADÁ) | | mestre | | pending | Different person, same apelido |
```

**Note on Apelido Context:** When multiple capoeiristas share the same apelido, use `apelido_context` to disambiguate. Examples:
- Geographic: "Salvador", "São Paulo", "Rio de Janeiro"
- Group: "Senzala", "ABADÁ", "GCAP"
- Era: "19th century", "modern"
- Combined: "Salvador (Senzala)", "19th century Rio"

### `groups-backlog.md` - Groups to Import

```markdown
# Groups Import Backlog

## Status Legend
- `pending` - Not yet processed
- `in_progress` - Currently researching
- `done` - SQL generated, added to import set
- `skipped` - Decided not to import (document reason)

## Backlog

| Name | Style | Discovered From | Status | Notes |
|------|-------|-----------------|--------|-------|
| GCAP | angola | Mestre Moraes import | pending | |
| CECA | angola | João Grande import | done | Historical |
| Grupo Senzala | mixed | Cordão de Ouro import | pending | Major group |
```

---

## Import Set Files

Store generated SQL in `docs/genealogy/import-sql/`:

### File Naming Convention

```
YYYY-MM-DD_[type]_[name].sql
```

Examples:
- `2025-01-15_person_joao-grande.sql`
- `2025-01-15_group_gcap.sql`
- `2025-01-16_person_pastinha.sql`

### Consolidation

Periodically consolidate individual import files into a batch:

```
2025-01-batch-01_historical-angoleiros.sql
```

---

## Entity Registry

Once entities are imported, track their UUIDs in `docs/genealogy/entity-registry.md`:

```markdown
# Entity Registry

## Persons

| Apelido | UUID | Imported On |
|---------|------|-------------|
| Pastinha | (will be assigned on import) | 2025-01-15 |
| João Grande | (will be assigned on import) | 2025-01-15 |

## Groups

| Name | UUID | Imported On |
|------|------|-------------|
| CECA | (will be assigned on import) | 2025-01-15 |
| GCAP | (will be assigned on import) | 2025-01-15 |
```

**Note:** UUIDs are generated by `gen_random_uuid()` at import time. After running imports, update this registry with actual UUIDs from the database.

---

## Relationship Tracking

When generating statements, track which relationships are:

### Pending (entities not yet imported)

```markdown
## Pending Relationships

| Subject | Predicate | Object | Blocked By |
|---------|-----------|--------|------------|
| Moraes | student_of | João Grande | João Grande not imported |
| GCAP | split_from_group | CECA | CECA not imported |
```

### Ready (both entities exist)

These can be added to your import SQL immediately.

---

## Typical Session Flow

1. **Pick entity from backlog** - e.g., "Mestre João Grande"
2. **Run import command** - `/import-person Mestre João Grande`
3. **Review output**
   - Copy SQL to `docs/genealogy/import-sql/2025-01-15_person_joao-grande.sql`
   - **Ensure bilingual content**: Verify both `_en` and `_pt` fields are populated for bio, achievements, style_notes (persons) or description, history, philosophy, style_notes (groups)
   - Add discovered persons to `persons-backlog.md`
   - Add discovered groups to `groups-backlog.md`
   - Mark João Grande as `done` in `persons-backlog.md`
4. **Check for ready relationships** - If related entities already done, add statements
5. **Repeat** with next entity

---

## Best Practices

1. **Start with historical figures** - They have the most documentation and are referenced by many
2. **Work in lineage chains** - Import teachers before students for cleaner relationship generation
3. **Batch by group** - When processing a group, also process key founders/leaders
4. **Verify before import** - Review all SQL before running against database
5. **Run imports in transaction** - Keep `BEGIN;` and `COMMIT;` wrapper
6. **Save UUIDs** - After import, capture actual UUIDs for future reference
7. **Capture bilingual content** - All narrative fields require both English (`_en`) and Portuguese (`_pt`) versions. See `BILINGUAL_CONTENT.md` for details
8. **Use apelido_context for duplicates** - When importing someone with a common apelido, add context to disambiguate

---

## Handling Duplicate Apelidos

The database uses a composite unique index on `(apelido, apelido_context)`. This allows multiple people with the same apelido as long as they have different contexts.

### When to Use apelido_context

- **Required**: When the apelido already exists in the database with NULL context
- **Recommended**: For common apelidos like "Mestre Cobra", "Mestre Gato", "Mestre Nô"
- **Optional**: For historically unique apelidos like "Pastinha", "Bimba", "Nascimento Grande"

### SQL Import Pattern for Disambiguation

```sql
-- Standard import (unique apelido, no context needed)
INSERT INTO genealogy.person_profiles (apelido, apelido_context, ...)
VALUES ('Pastinha', NULL, ...)
ON CONFLICT (apelido, COALESCE(apelido_context, '')) WHERE apelido IS NOT NULL
DO UPDATE SET ...;

-- Import with context (duplicate apelido)
INSERT INTO genealogy.person_profiles (apelido, apelido_context, ...)
VALUES ('Mestre Cobra', 'Salvador (Senzala)', ...)
ON CONFLICT (apelido, COALESCE(apelido_context, '')) WHERE apelido IS NOT NULL
DO UPDATE SET ...;
```

### Referencing in Statements

When creating statements, include context in the WHERE clause if the person has one:

```sql
-- Reference person without context
WHERE p.apelido = 'Pastinha' AND p.apelido_context IS NULL

-- Reference person with context
WHERE p.apelido = 'Mestre Cobra' AND p.apelido_context = 'Salvador (Senzala)'
```

### Context Naming Conventions

| Pattern | Example | When to Use |
|---------|---------|-------------|
| City | `Salvador` | When city is sufficient |
| City (Group) | `Salvador (Senzala)` | When multiple in same city |
| Era | `19th century` | For historical disambiguation |
| Era + City | `19th century Rio` | For historical figures in specific locations |
| Group only | `ABADÁ` | When group affiliation is the key differentiator |

---

## Directory Structure

```
docs/genealogy/
├── import-tracking.md          # This file
├── import-backlog/
│   ├── persons-backlog.md      # Persons to import
│   └── groups-backlog.md       # Groups to import
├── import-sql/
│   ├── 2025-01-15_person_pastinha.sql
│   ├── 2025-01-15_person_joao-grande.sql
│   ├── 2025-01-15_group_ceca.sql
│   └── ...
├── entity-registry.md          # Imported entities with UUIDs
└── case-studies/               # Existing research (reference)
```
