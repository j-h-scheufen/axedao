name: Deploy Genealogy Data (Staging)

on:
  # Run when migration file changes on develop
  push:
    branches:
      - develop
    paths:
      - 'docs/genealogy/sql-imports/build/pending-migration.sql'
  # Manual trigger - must be run from develop branch
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (show SQL without applying)'
        type: boolean
        default: false

# Prevent concurrent deployments
concurrency:
  group: genealogy-staging
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy Genealogy Data to Staging
    runs-on: ubuntu-latest
    environment: staging
    timeout-minutes: 10
    # Only run if triggered from develop branch
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Verify branch
        run: |
          echo "Workflow triggered from: ${{ github.ref }}"
          echo "Event: ${{ github.event_name }}"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.ref }}" != "refs/heads/develop" ]]; then
            echo "::error::Staging deployment can only be triggered from the develop branch. Current branch: ${{ github.ref }}"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: develop  # Always deploy from develop branch

      - name: Wait for Atlas migration to complete
        if: github.event_name == 'push'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Waiting for Atlas staging migration to complete..."
          WORKFLOW_NAME="Staging Database Migration (Atlas)"
          MAX_WAIT=300  # 5 minutes max wait
          POLL_INTERVAL=10
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Check for in_progress or queued runs of Atlas workflow on this commit
            RUNNING=$(gh run list \
              --workflow="$WORKFLOW_NAME" \
              --branch=develop \
              --json status,conclusion,headSha \
              --jq "[.[] | select(.headSha==\"${{ github.sha }}\" and (.status==\"in_progress\" or .status==\"queued\"))] | length")

            if [ "$RUNNING" = "0" ]; then
              echo "No Atlas workflow running - checking if it completed successfully..."

              # Check if Atlas completed successfully for this commit
              RESULT=$(gh run list \
                --workflow="$WORKFLOW_NAME" \
                --branch=develop \
                --json status,conclusion,headSha \
                --jq "[.[] | select(.headSha==\"${{ github.sha }}\" and .status==\"completed\")] | first | .conclusion // \"not_found\"")

              if [ "$RESULT" = "success" ]; then
                echo "Atlas migration completed successfully"
                exit 0
              elif [ "$RESULT" = "not_found" ]; then
                echo "Atlas workflow not found for this commit - proceeding (may not have schema changes)"
                exit 0
              else
                echo "::error::Atlas migration did not succeed (status: $RESULT)"
                exit 1
              fi
            fi

            echo "Atlas workflow still running... waiting ${POLL_INTERVAL}s (${ELAPSED}s elapsed)"
            sleep $POLL_INTERVAL
            ELAPSED=$((ELAPSED + POLL_INTERVAL))
          done

          echo "::error::Timeout waiting for Atlas migration to complete"
          exit 1

      - name: Check for pending migration
        id: check
        run: |
          MIGRATION_FILE="docs/genealogy/sql-imports/build/pending-migration.sql"

          # Check if file exists
          if [ ! -f "$MIGRATION_FILE" ]; then
            echo "has_migration=false" >> $GITHUB_OUTPUT
            echo "No migration file found - nothing to deploy"
            exit 0
          fi

          # For push events, the paths filter already ensures the file changed
          # For workflow_dispatch, always deploy if file exists
          echo "has_migration=true" >> $GITHUB_OUTPUT
          echo "Migration file found - proceeding with deployment"

      - name: Show migration contents (dry run)
        if: steps.check.outputs.has_migration == 'true' && (github.event.inputs.dry_run == 'true' || github.event_name == 'workflow_dispatch')
        run: |
          echo "=== Migration SQL Contents ==="
          cat docs/genealogy/sql-imports/build/pending-migration.sql

      - name: Apply migration to staging
        if: steps.check.outputs.has_migration == 'true' && github.event.inputs.dry_run != 'true'
        env:
          STAGING_DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: |
          echo "Applying genealogy data migration to staging..."
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo ""

          psql "$STAGING_DATABASE_URL" -f docs/genealogy/sql-imports/build/pending-migration.sql

          EXIT_CODE=$?
          if [ $EXIT_CODE -ne 0 ]; then
            echo ""
            echo "Migration failed with exit code $EXIT_CODE"
            exit 1
          fi

          echo ""
          echo "Migration completed successfully"

      - name: Verify deployment
        if: steps.check.outputs.has_migration == 'true' && github.event.inputs.dry_run != 'true'
        env:
          STAGING_DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: |
          echo "=== Genealogy Data Statistics ==="
          psql "$STAGING_DATABASE_URL" -c "
            SELECT 'person_profiles' as table_name, COUNT(*) as count FROM genealogy.person_profiles
            UNION ALL
            SELECT 'group_profiles', COUNT(*) FROM genealogy.group_profiles
            UNION ALL
            SELECT 'statements', COUNT(*) FROM genealogy.statements;
          "

      - name: Create deployment report
        if: always()
        run: |
          echo "# Genealogy Staging Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.has_migration }}" != "true" ]; then
            echo "No pending-migration.sql file found. Nothing to deploy." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "**Status:** Dry run completed (no changes applied)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" = "success" ]; then
            echo "**Status:** Deployment successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Next steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. Verify data on staging" >> $GITHUB_STEP_SUMMARY
            echo "2. Run \`mv docs/genealogy/sql-imports/build/pending-state.json docs/genealogy/sql-imports/deployed-state.json\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Commit deployed-state.json" >> $GITHUB_STEP_SUMMARY
            echo "4. Merge to main for production deployment" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** Deployment failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Genealogy staging deployment failed. Check the logs above for details."
